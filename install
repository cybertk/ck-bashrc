#!/usr/bin/env bash

_DEFAULT_FILES=""
_SHELL_PROFILES=".bashrc .bash_profile"

backup() {
    declare dots="$1" backup_dir="$2"
    local dest

    # Ensure destination dir exist
    dest="$backup_dir/$(date "+%Y%m%d-%H%M%S")"
    mkdir -p "$dest"

    for dot in $dots $_SHELL_PROFILES; do
        local f

        f="$HOME/$dot"

        # Skiping if file un-exist
        [[ -e "$f" ]] || continue

        # TODO: detect if file is same as in dots-config
        echo "==> Backing up $dot"
        cp -r "$f" "$dest"
    done
    echo "==> All dots are backed up to $dest"
}

install_profile() {
    declare profile="$1" config_path="$2"

    cat >"$profile" <<EOF
#!/bin/sh

# NOTE: Do **NOT** edit this file.
#   This file is automated generated by ckdots cybertk/ckdots.
#   Edit profile/bashrc instead.

CKDOTS_ROOT="$PWD"
CKDOTS_CONFIG="${config_path}"
. \${CKDOTS_ROOT}/profile
EOF
}

# Install one dotfile($1) to $HOME
install_dot_file() {
    local dot_file="$1"

    ln -sf "$dot_file" ~/
}

install() {
    declare dots="$1" path="$2"

    for dot in $dots; do
        local f="$path/dots/$dot"

        echo "==> Installing $dot"
        install_dot_file "$f" "$path"
    done
    install_profile ~/.bash_profile "$path"
}

# Usage:
# install - Install/Restore configs on a new machine
# save - Save new dot file
main() {
    local config_path dots

    config_path=${CKDOTS_CONFIG:-~/.ckdots-config}

    # 1, Load from repo: ckdots-config
    # 2, Load from env: $CKDOTS_FILES
    # 3, Fallback to defaults
    if [[ -f "$CKDOTS_CONFIG/config.sh" ]]; then
        # shellcheck source=/dev/null
        . "$CKDOTS_CONFIG/config.sh"
        dots=$CONFIG_DOTS
        echo "==> Load dots from config:$CKDOTS_CONFIG: $dots"
    elif [[ -n "$CKDOTS_FILES" ]]; then
        dots=$CKDOTS_FILES
        echo "==> Reading files from \$CKDOTS_FILES: $CKDOTS_FILES"
    fi

    if [[ -z "$dots" ]]; then
        ${dots:=$_DEFAULT_FILES}
        echo "==> Falling back to default files: $dots"
    fi

    backup "$dots" "$config_path/backup"
    install "$dots" "$config_path"
}

main "$@"
